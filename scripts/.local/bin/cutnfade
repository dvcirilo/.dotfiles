#!/bin/bash

# A simple script to cut an audio file to a specific duration and add a 5-second fade-out.
# The output file will have "-CUT" appended to its name.

# --- Configuration ---
# The duration of the fade-out in seconds.
FADE_DURATION=5

# --- Input Validation ---
# Check if exactly two arguments (filename and duration) were provided.
if [ "$#" -ne 2 ]; then
    echo "Usage: $0 <filename> <cut_duration_in_seconds>"
    echo "Example: $0 my_song.mp3 90"
    exit 1
fi

# --- Variable Setup ---
# The input file path provided by the user.
INPUT_FILE="$1"
# The total duration to cut the file to, in seconds.
CUT_DURATION=$2

# Check if the input file actually exists.
if [ ! -f "$INPUT_FILE" ]; then
    echo "Error: File not found at '$INPUT_FILE'"
    exit 1
fi

# --- Calculations ---
# Calculate the exact time the fade-out should begin.
# This is the cut duration minus the fade duration.
FADE_START_TIME=$((CUT_DURATION - FADE_DURATION))

# Check if the cut duration is long enough for the fade-out.
if [ "$FADE_START_TIME" -lt 0 ]; then
    echo "Error: Cut duration ($CUT_DURATION's) is too short for a $FADE_DURATION's fade-out."
    exit 1
fi

# --- Filename Generation ---
# Get the filename without the extension.
FILENAME_NO_EXT="${INPUT_FILE%.*}"
# Get the file extension.
EXTENSION="${INPUT_FILE##*.}"
# Create the new output filename by adding "-CUT" before the extension.
OUTPUT_FILE="${FILENAME_NO_EXT}-CUT.${EXTENSION}"

# --- Execution ---
# Display a message to the user showing what is about to happen.
echo "Processing: '$INPUT_FILE'"
echo "  -> Cutting to: $CUT_DURATION seconds"
echo "  -> Fading out for: $FADE_DURATION seconds, starting at $FADE_START_TIME seconds"
echo "  -> Saving as: '$OUTPUT_FILE'"

# Run the FFmpeg command with all the calculated variables.
ffmpeg -i "$INPUT_FILE" -to "$CUT_DURATION" -af "afade=t=out:st=$FADE_START_TIME:d=$FADE_DURATION" -y "$OUTPUT_FILE"

# Check the exit code of the ffmpeg command to see if it succeeded.
if [ $? -eq 0 ]; then
    echo "✅ Success! File created: '$OUTPUT_FILE'"
else
    echo "❌ Error: FFmpeg command failed."
    exit 1
fi
